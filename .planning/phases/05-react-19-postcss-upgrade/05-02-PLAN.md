---
phase: 05-react-19-postcss-upgrade
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - postcss.config.cjs
  - pnpm-lock.yaml
autonomous: true

must_haves:
  truths:
    - "postcss-preset-env v11.x is installed and functional"
    - "PostCSS config correctly loads postcss-preset-env v11 with stage 2 features"
    - "CSS processing works correctly through the PostCSS pipeline"
    - "Production build succeeds with correct CSS output"
  artifacts:
    - path: "postcss.config.cjs"
      provides: "PostCSS configuration with preset-env v11"
      contains: "postcss-preset-env"
    - path: "package.json"
      provides: "postcss-preset-env v11 dependency"
      contains: "postcss-preset-env"
  key_links:
    - from: "postcss.config.cjs"
      to: "postcss-preset-env"
      via: "require() plugin registration"
      pattern: "postcss-preset-env"
    - from: "astro.config.mjs"
      to: "postcss.config.cjs"
      via: "Vite auto-discovers PostCSS config"
      pattern: "postcss"
---

<objective>
Upgrade postcss-preset-env from v9.5.2 to v11.x and fix the existing PostCSS configuration bug.

Purpose: Complete PCSS-01 requirement. The current postcss.config.cjs has a bug: `require('postcss-preset-env', { stage: 2 })` passes options as the second argument to Node's require(), not to the PostCSS plugin. This means stage 2 features were never actually configured. The upgrade to v11 fixes this and provides modern CSS feature support. PostCSS v11 is ESM-only but works with Node's native `require(esm)` on Node v25.2.1.

Output: Updated postcss-preset-env dependency, fixed PostCSS config with proper plugin invocation.
</objective>

<execution_context>
@/Users/mini/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mini/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-react-19-postcss-upgrade/05-RESEARCH.md
@postcss.config.cjs
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Upgrade postcss-preset-env to v11 and fix config</name>
  <files>postcss.config.cjs, pnpm-lock.yaml</files>
  <action>
First, upgrade postcss-preset-env:

```bash
pnpm add -D postcss-preset-env@^11.1.3
```

Then fix the postcss.config.cjs file. The current config has a bug:

```js
// CURRENT (BROKEN) - options passed to require(), not to plugin
require('postcss-preset-env', { stage: 2 })
```

Fix to properly invoke the plugin with options:

```js
// CORRECT - require plugin, then call with options
require('postcss-preset-env')({ stage: 2 })
```

The full corrected postcss.config.cjs should be:

```js
module.exports = {
	plugins: [
		require('postcss-preset-env')({
			stage: 2,
		})
	]
}
```

NOTE: Keep the file as .cjs (CommonJS). PostCSS preset-env v11 is ESM-only, but Node v25.2.1 supports `require(esm)` natively, so `require('postcss-preset-env')` works correctly.

Also check if `autoprefixer` in package.json dependencies is still needed. With postcss-preset-env v11, autoprefixer is included by default (autoprefixerOption in preset-env). However, autoprefixer is listed in both dependencies AND devDependencies. The duplicate in `dependencies` should be removed (it belongs only in devDependencies if kept at all). But since postcss-preset-env v11 includes autoprefixer, the separate autoprefixer package may be redundant. Leave autoprefixer in place for now to avoid risk - it will be a no-op if preset-env handles prefixing, and removing it could break if any other config references it.

After editing, verify PostCSS processes CSS correctly:

```bash
pnpm run build
```
  </action>
  <verify>
1. `pnpm list postcss-preset-env` shows 11.x
2. PostCSS config file contains `require('postcss-preset-env')({ stage: 2 })` (proper invocation)
3. `pnpm run build` exits with 0 status
4. No PostCSS-related warnings in build output
  </verify>
  <done>postcss-preset-env upgraded to v11.x. PostCSS config fixed with proper plugin invocation syntax. Production build succeeds with correct CSS processing.</done>
</task>

<task type="auto">
  <name>Task 2: Verify CSS feature processing and build output</name>
  <files></files>
  <action>
Run the production build and verify CSS is processed correctly:

```bash
pnpm run build
```

After build, inspect the output CSS to confirm PostCSS processing:

1. Check that the build output in `dist/` contains processed CSS files
2. Verify no PostCSS errors or warnings in build output
3. Run the preview server briefly to confirm pages load:

```bash
# Start preview server, check it responds, then stop
pnpm run preview &
sleep 3
curl -s -o /dev/null -w "%{http_code}" http://localhost:4321/
kill %1
```

Expected: HTTP 200 response. The site should render identically since PostCSS stage 2 features were the intended configuration (even though the old config had a bug, the default stage for postcss-preset-env is stage 2 anyway, so behavior should be unchanged).

Also verify there are no duplicate or conflicting CSS processing. The project uses:
- @tailwindcss/vite (Tailwind 4 via Vite plugin)
- postcss.config.cjs (PostCSS with preset-env)

These are complementary: Tailwind handles utility classes, PostCSS handles modern CSS syntax transpilation. No conflicts expected.
  </action>
  <verify>
1. `pnpm run build` succeeds
2. `ls dist/_astro/*.css` shows CSS output files
3. Preview server returns HTTP 200
  </verify>
  <done>Production build succeeds. CSS output files present in dist/_astro/. Site serves correctly on preview server. PostCSS v11 processes CSS without errors.</done>
</task>

</tasks>

<verification>
1. `pnpm list postcss-preset-env` shows 11.x
2. PostCSS config has correct plugin invocation syntax
3. `pnpm run build` succeeds
4. CSS output files exist in dist/_astro/
5. Preview server returns HTTP 200
</verification>

<success_criteria>
- PCSS-01: postcss-preset-env upgraded to v11 with correct CSS processing
- PostCSS config bug fixed (options properly passed to plugin)
- Production build succeeds with processed CSS
- No regressions in CSS output
</success_criteria>

<output>
After completion, create `.planning/phases/05-react-19-postcss-upgrade/05-02-SUMMARY.md`
</output>
