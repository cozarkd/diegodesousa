---
phase: 02-zod-4-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - pnpm-lock.yaml
autonomous: true

must_haves:
  truths:
    - "Content collection schemas validate correctly with Zod 4 API"
    - "All 20 content entries (5 projects x 4 locales) load without validation errors"
    - "TypeScript type checking passes for schema definitions and content consumers"
    - "Production build completes without errors"
    - "Dev server starts and renders project pages correctly"
  artifacts:
    - path: "package.json"
      provides: "Zod 4.x dependency"
      contains: "zod.*4"
    - path: "src/content/config.ts"
      provides: "Content collection schema (unchanged)"
      contains: "z.object"
    - path: "src/components/sections/ProjectsSection.astro"
      provides: "Content consumer (unchanged)"
      contains: "getCollection"
  key_links:
    - from: "package.json"
      to: "src/content/config.ts"
      via: "zod import through astro:content"
      pattern: "from 'astro:content'"
    - from: "src/content/config.ts"
      to: "src/content/projects/"
      via: "schema validates frontmatter of all .md entries"
      pattern: "defineCollection"
    - from: "src/content/config.ts"
      to: "src/components/sections/ProjectsSection.astro"
      via: "getCollection returns typed data shaped by schema"
      pattern: "getCollection\\('projects'\\)"
---

<objective>
Upgrade Zod from 3.23.8 to 4.x and verify all content collection schemas, entries, and consumers work correctly.

Purpose: Zod 4 is a prerequisite for the Astro 5 migration (Phase 3). The current schema uses only v4-compatible patterns (.optional() without .default(), .refine() on images, z.any()), so this is a package upgrade + verification, not a refactor.

Output: Working site with Zod 4 — identical behavior, passing type checks, successful builds.
</objective>

<execution_context>
@/Users/mini/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mini/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-zod-4-migration/02-RESEARCH.md
@src/content/config.ts
@src/components/sections/ProjectsSection.astro
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Upgrade Zod to v4 and audit schema compatibility</name>
  <files>package.json, pnpm-lock.yaml</files>
  <action>
1. Upgrade Zod to latest v4:
   ```bash
   pnpm add zod@^4
   ```
   Note: Use pnpm (project uses pnpm-lock.yaml, not package-lock.json).

2. Verify no peer dependency conflicts in install output. If Astro 4.5.4 pins a specific Zod version, check for resolution warnings.

3. Audit src/content/config.ts for Zod 4 breaking patterns:
   - Search for `.optional().default()` combination — MUST NOT exist (breaking change in v4: defaults now apply through optional). Current schema: CLEAR per research — only uses .optional() without .default().
   - Search for `.string().email()`, `.string().url()`, `.string().uuid()` — deprecated method syntax in v4. Current schema: CLEAR — none used.
   - Search for `.merge()` — deprecated in v4, use .extend() instead. Current schema: CLEAR — not used.
   - Search for `.strict()` — deprecated in v4, use z.strictObject(). Current schema: CLEAR — not used.
   - Verify `.refine()` on image() still uses simple callback (not type predicate). Current: `(img) => img.width >= 300` — compatible.
   - Verify `z.any()` still valid — yes, confirmed in v4 docs.

4. If any breaking patterns found (unexpected), fix them following the patterns in 02-RESEARCH.md. Based on research, no changes to config.ts should be needed.

Do NOT modify src/content/config.ts unless a breaking pattern is discovered during audit. The schema is already v4-compatible.
  </action>
  <verify>
Run: `pnpm ls zod` — should show zod 4.x.x
Run: `grep -n "optional.*default\|\.email()\|\.url()\|\.uuid()\|\.merge()\|\.strict()" src/content/config.ts` — should return empty (no breaking patterns)
  </verify>
  <done>Zod 4.x installed in package.json. No peer dependency conflicts. Schema audit confirms no breaking patterns exist in src/content/config.ts.</done>
</task>

<task type="auto">
  <name>Task 2: Verify content loading, type checking, and build</name>
  <files></files>
  <action>
1. Run TypeScript/Astro type checking:
   ```bash
   pnpm astro check
   ```
   This validates all schema types, content collection types, and component prop types. Must pass with zero errors. Warnings are acceptable if pre-existing.

2. Run production build (which includes astro check via the build script):
   ```bash
   pnpm build
   ```
   This will:
   - Type-check all files (astro check)
   - Build all 4 locale pages (/, /en/, /pt/, /gl/)
   - Validate all 20 content entries against the Zod 4 schema
   - Process images through sharp (including refine validation on cover images)

   Must complete with zero errors. Watch specifically for:
   - Schema validation errors on any content entry
   - Image refine validation failures ("Cover image must be at least 300 pixels wide!")
   - Type errors in ProjectsSection.astro (the only getCollection consumer)

3. Start dev server and verify it serves correctly:
   ```bash
   pnpm dev &
   sleep 5
   curl -s -o /dev/null -w "%{http_code}" http://localhost:4321/
   curl -s -o /dev/null -w "%{http_code}" http://localhost:4321/en/
   ```
   Both should return 200. Kill dev server after verification.

4. If any step fails:
   - Schema validation error: Check the specific field/entry, apply fix from 02-RESEARCH.md patterns
   - Type error in component: Check if Zod 4 changed inferred types for optional fields
   - Image refine error: Verify img.width is still available in the refine callback
   - Build error: Check Astro compatibility with Zod 4 (may need to check Astro changelog)

Do NOT introduce new tests or test files. This is verification of existing functionality after a dependency upgrade.
  </action>
  <verify>
Run: `pnpm astro check` — exits with code 0
Run: `pnpm build` — exits with code 0, all 4 locales built
Run: `pnpm dev` then `curl http://localhost:4321/` — returns HTTP 200
  </verify>
  <done>astro check passes with zero errors. Production build succeeds for all 4 locales. Dev server starts and returns 200 for root and /en/ paths. All 20 content entries validate against Zod 4 schema without errors.</done>
</task>

</tasks>

<verification>
Phase-level verification after both tasks complete:

1. `pnpm ls zod` shows version 4.x.x (not 3.x)
2. `pnpm build` exits cleanly (this runs astro check + full build)
3. No files modified other than package.json and pnpm-lock.yaml (schema was already compatible)
4. Dev server renders pages correctly at localhost:4321

Requirements coverage:
- ZOD-01 (schemas work with Zod 4 API): Verified by astro check + build passing with Zod 4
- ZOD-02 (all content entries load correctly): Verified by successful build processing all 20 entries
</verification>

<success_criteria>
- Zod upgraded from 3.23.8 to 4.x in package.json
- pnpm install completes without peer dependency conflicts
- astro check passes with zero errors
- pnpm build succeeds (all 4 locales, all 20 content entries)
- Dev server starts and serves pages at localhost:4321
- src/content/config.ts unchanged (already v4-compatible)
- ProjectsSection.astro unchanged (types still valid)
</success_criteria>

<output>
After completion, create `.planning/phases/02-zod-4-migration/02-01-SUMMARY.md`
</output>
