---
phase: 03-astro-5-upgrade
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - astro.config.mjs
  - src/components/sections/ProjectsSection.astro
autonomous: false

must_haves:
  truths:
    - "All 4 locale pages (/, /en/, /pt/, /gl/) render correctly in production build"
    - "Content collections return all 20 entries with correct schema-validated data"
    - "Dev server starts and serves pages with hot module reload"
    - "Contact form submits correctly (Web3Forms client-side fetch)"
    - "Type checking passes with astro check"
  artifacts:
    - path: "dist/index.html"
      provides: "Built Spanish (default) locale page"
    - path: "dist/en/index.html"
      provides: "Built English locale page"
    - path: "dist/pt/index.html"
      provides: "Built Portuguese locale page"
    - path: "dist/gl/index.html"
      provides: "Built Galician locale page"
  key_links:
    - from: "src/components/sections/ProjectsSection.astro"
      to: "src/content.config.ts"
      via: "getCollection('projects') returns entries with .data fields"
      pattern: "getCollection.*projects"
    - from: "src/pages/index.astro"
      to: "src/components/pages/index.astro"
      via: "component import and render"
      pattern: "IndexPage"
    - from: "astro.config.mjs"
      to: "src/pages/{en,pt,gl}/index.astro"
      via: "i18n routing configuration"
      pattern: "i18n.*locales"
---

<objective>
Verify the Astro 5 upgrade works end-to-end: all 4 locale pages build and render correctly, content collections return expected data, dev server works, and fix any remaining compatibility issues.

Purpose: Ensure zero regression from the framework upgrade. The site must produce identical output across all locales with correct content data, functioning form, and working dev experience.

Output: Verified working site on Astro 5 across all locales with all content rendering correctly.
</objective>

<execution_context>
@/Users/mini/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mini/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-astro-5-upgrade/03-RESEARCH.md
@.planning/phases/03-astro-5-upgrade/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix any build or compatibility issues from Astro 5 upgrade</name>
  <files>astro.config.mjs, src/components/sections/ProjectsSection.astro</files>
  <action>
Run `pnpm build` and analyze any errors. Common issues to fix:

**Potential issue 1: @astrojs/tailwind compatibility with Astro 5**
If the build fails because `@astrojs/tailwind` v5.1.0 is incompatible with Astro 5, check if a newer version exists. If not, the Tailwind integration may need to stay at current version or be temporarily worked around. Note: Do NOT upgrade Tailwind CSS itself — that is Phase 4.

Try `pnpm install @astrojs/tailwind@latest` if there is a compatible version. If no Astro 5-compatible version exists, the integration may need to be replaced with direct Vite CSS config. Document the issue.

**Potential issue 2: tailwindcss/nesting import**
If `import tailwindcssNesting from 'tailwindcss/nesting'` fails, remove the Vite postcss plugins section from astro.config.mjs. The nesting support will be addressed in Phase 4.

**Potential issue 3: Third-party integration compatibility**
If `astro-robots-txt`, `astro-navbar`, or `astro-fathom` cause errors, try upgrading to latest: `pnpm install astro-robots-txt@latest astro-navbar@latest astro-fathom@latest`.

**Potential issue 4: Content collection entry.id format**
In Content Layer API with glob loader, `entry.id` may include locale subdirectory path (e.g., `es/captain-canvas` instead of just `captain-canvas`). Since ProjectsSection.astro does NOT use entry.id or entry.slug (only entry.data fields), this should not cause issues. Verify by checking build output.

**If build passes with zero issues:** Skip this task — no files need modification. Proceed directly to Task 2.

For each fix applied, document what changed and why. Only make the minimum changes needed to get the build passing. Do NOT refactor or optimize — this is a migration, not a rewrite.
  </action>
  <verify>
`pnpm build` completes with exit code 0. All 4 locale pages are present in dist/:
- dist/index.html (Spanish, default)
- dist/en/index.html (English)
- dist/pt/index.html (Portuguese)
- dist/gl/index.html (Galician)
  </verify>
  <done>Production build succeeds with all 4 locale pages. Any compatibility issues documented and resolved with minimal changes.</done>
</task>

<task type="auto">
  <name>Task 2: Verify dev server, type checking, and content data integrity</name>
  <files></files>
  <action>
**Step 1: Run type checking**
Run `pnpm astro check` and verify it passes with 0 errors. Warnings and hints are acceptable (there were 13 pre-existing unused import hints from Phase 2).

**Step 2: Start dev server and verify pages**
Run `pnpm dev` and verify:
- Root page (http://localhost:4321/) returns HTTP 200
- English page (http://localhost:4321/en/) returns HTTP 200
- Portuguese page (http://localhost:4321/pt/) returns HTTP 200
- Galician page (http://localhost:4321/gl/) returns HTTP 200

Use `curl -s -o /dev/null -w "%{http_code}" http://localhost:4321/` to check HTTP status codes.

**Step 3: Verify content data integrity**
The ProjectsSection filters projects by `project.data.language === currentLocale` and `!project.data.isDraft`. Verify by checking the built HTML contains project data:
- Check that `dist/index.html` contains Spanish project content (e.g., project titles in Spanish)
- Check that `dist/en/index.html` contains English project content

**Step 4: Verify no console errors**
Check the build output for warnings about deprecation, missing modules, or content validation failures.

This task produces NO file changes — it is pure verification. If any check fails, document the failure and fix it (which would modify files from Task 1).
  </action>
  <verify>
1. `pnpm astro check` exits with code 0 and 0 errors
2. `pnpm dev` serves all 4 locale pages with HTTP 200
3. Built HTML contains expected content data per locale
4. No content validation errors in build output
  </verify>
  <done>All 4 locale pages render correctly. Content collections return expected data. Type checking passes. Dev server works with HMR. No regression from Astro 4 to Astro 5.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Visual verification of all locale pages</name>
  <files></files>
  <action>
CHECKPOINT — Pause for user visual verification.

What was built: Astro 5 upgrade with Content Layer API migration. All packages updated, content config migrated to glob loader, TypeScript config updated.

User should verify:
1. Run `pnpm dev` (should already be running from Task 2)
2. Open http://localhost:4321/ in your browser — verify Spanish page looks correct
3. Open http://localhost:4321/en/ — verify English page looks correct
4. Open http://localhost:4321/pt/ — verify Portuguese page looks correct
5. Open http://localhost:4321/gl/ — verify Galician page looks correct
6. Check that:
   - Projects section shows the correct projects per locale
   - Images load correctly (cover images for projects)
   - Navigation works between pages
   - Contact form is present and interactive
   - Seasonal theme styling is applied correctly
   - No visual regressions compared to pre-upgrade

Resume signal: Type "approved" if all pages look correct, or describe any visual issues found.
  </action>
  <verify>User confirms all 4 locale pages render correctly with no visual regressions.</verify>
  <done>User has visually verified all locale pages. No regressions found from Astro 5 upgrade.</done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds for all 4 locales with exit code 0
2. `pnpm astro check` passes with 0 errors
3. Dev server serves all 4 locale pages (HTTP 200)
4. Content data appears correctly in built HTML for each locale
5. User confirms visual correctness across all locales
</verification>

<success_criteria>
- All 4 locale pages build and render correctly (ASTRO-03)
- Content collections return expected data through Content Layer API
- Type checking passes with astro check
- Dev server hot module reload works
- No visual regressions confirmed by user
</success_criteria>

<output>
After completion, create `.planning/phases/03-astro-5-upgrade/03-02-SUMMARY.md`
</output>
