---
phase: 03-astro-5-upgrade
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - pnpm-lock.yaml
  - src/content.config.ts
  - src/content/config.ts
  - astro.config.mjs
  - tsconfig.json
  - src/env.d.ts
autonomous: true

must_haves:
  truths:
    - "Astro 5 and Vite 6 are installed and functional"
    - "Content Layer API is active with glob loader for projects collection"
    - "All integrations (@astrojs/mdx, @astrojs/react, @astrojs/sitemap) are Astro 5 compatible"
    - "TypeScript types are generated correctly via .astro/types.d.ts"
  artifacts:
    - path: "src/content.config.ts"
      provides: "Content Layer API collection definitions with glob loader"
      contains: "glob"
    - path: "package.json"
      provides: "Astro 5 and updated integration dependencies"
      contains: "astro"
    - path: "astro.config.mjs"
      provides: "Astro 5 config with updated integrations"
      contains: "defineConfig"
    - path: "tsconfig.json"
      provides: "TypeScript config with .astro/types.d.ts include"
      contains: ".astro/types.d.ts"
  key_links:
    - from: "src/content.config.ts"
      to: "src/content/projects/**/*.md"
      via: "glob loader base path"
      pattern: "glob.*base.*src/content/projects"
    - from: "astro.config.mjs"
      to: "@astrojs/mdx"
      via: "integration registration"
      pattern: "mdx\\(\\)"
    - from: "src/components/sections/ProjectsSection.astro"
      to: "src/content.config.ts"
      via: "getCollection('projects')"
      pattern: "getCollection.*projects"
---

<objective>
Upgrade Astro from 4.5.4 to 5.x with all integrations, migrate content collections to the Content Layer API, and update TypeScript configuration.

Purpose: Establish Astro 5 as the core framework with Content Layer API, enabling 5x faster Markdown builds and modern Vite 6 tooling. This is the foundation for all subsequent phases.

Output: Working Astro 5 installation with Content Layer API, updated integrations, and correct TypeScript configuration.
</objective>

<execution_context>
@/Users/mini/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mini/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-astro-5-upgrade/03-RESEARCH.md
@.planning/phases/02-zod-4-migration/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Upgrade Astro and all integrations to v5-compatible versions</name>
  <files>package.json, pnpm-lock.yaml</files>
  <action>
Upgrade all Astro-related packages using pnpm. Run:

```bash
pnpm install astro@latest @astrojs/mdx@latest @astrojs/react@latest @astrojs/sitemap@latest @astrojs/check@latest
```

After installation, verify versions with `pnpm ls astro @astrojs/mdx @astrojs/react @astrojs/sitemap @astrojs/check`.

Expected target versions:
- astro: ^5.x (brings Vite 6 automatically)
- @astrojs/mdx: ^4.x
- @astrojs/react: ^4.x
- @astrojs/sitemap: ^3.7+ (no v4 exists, latest 3.x is the target)
- @astrojs/check: ^0.9.6+

IMPORTANT: Do NOT upgrade @astrojs/tailwind, tailwindcss, react, react-dom, or any other packages — those are handled in Phase 4 and Phase 5.

Also remove the @astrojs/tailwind integration from the `integrations` array in astro.config.mjs is NOT part of this task — it stays for now since Tailwind 3 + @astrojs/tailwind may still work with Astro 5. If it causes build errors, keep it and note the issue.
  </action>
  <verify>
Run `pnpm ls astro @astrojs/mdx @astrojs/react @astrojs/sitemap @astrojs/check` and confirm:
- astro is 5.x
- @astrojs/mdx is 4.x
- @astrojs/react is 4.x
- @astrojs/sitemap is 3.7+
- @astrojs/check is 0.9.6+
  </verify>
  <done>All Astro packages upgraded to v5-compatible versions. No other packages changed.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate content collections to Content Layer API and update config files</name>
  <files>src/content.config.ts, src/content/config.ts, astro.config.mjs, tsconfig.json, src/env.d.ts</files>
  <action>
**Step 1: Create src/content.config.ts (new location for Content Layer API)**

Create `src/content.config.ts` with the following content — migrate from the legacy `type: 'content'` format to `loader: glob()` format:

```typescript
import { z, defineCollection } from 'astro:content'
import { glob } from 'astro/loaders'

const projects = defineCollection({
  loader: glob({
    pattern: '**/*.md',
    base: './src/content/projects'
  }),
  schema: ({ image }) =>
    z.object({
      title: z.string(),
      description: z.string(),
      link: z.string().optional(),
      video: z.string().optional(),
      cover: image()
        .refine((img) => img.width >= 300, {
          message: 'Cover image must be at least 300 pixels wide!'
        })
        .optional(),
      tags: z.array(
        z.object({
          name: z.string(),
          class: z.string(),
          icon: z.any().optional()
        })
      ),
      isDraft: z.boolean(),
      github: z.string().optional(),
      language: z.string()
    })
})

export const collections = { projects }
```

**Step 2: Delete the old src/content/config.ts**

Remove `src/content/config.ts` — Content Layer API requires the config at `src/content.config.ts` (project root of src/).

**Step 3: Update astro.config.mjs**

The `@astrojs/react` integration is in package.json but NOT imported or registered in astro.config.mjs. This is fine — Astro 5 does not require it to be registered if no React components use `client:*` directives. Leave astro.config.mjs as-is unless the build fails.

Check if `tailwindcss/nesting` import still resolves after Astro 5 upgrade. If it causes an import error, remove the `vite.css.postcss.plugins` section from astro.config.mjs (the nesting support will be addressed in Phase 4 Tailwind migration). Only make this change if the build fails.

**Step 4: Update tsconfig.json**

Update `tsconfig.json` to include `.astro/types.d.ts`:

```json
{
  "extends": "astro/tsconfigs/strict",
  "include": [".astro/types.d.ts", "**/*"],
  "exclude": ["dist"],
  "compilerOptions": {
    "strictNullChecks": true,
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"]
    }
  }
}
```

**Step 5: Clean up src/env.d.ts**

The current `src/env.d.ts` has:
```typescript
/// <reference path="../.astro/types.d.ts" />
/// <reference types="astro/client" />
```

In Astro 5, types are auto-generated in `.astro/types.d.ts` and included via tsconfig. The `env.d.ts` can remain but update to only keep `astro/client` reference (removes potential duplicate type registration):

```typescript
/// <reference types="astro/client" />
```

**Step 6: Run astro sync to regenerate types**

Run `pnpm astro sync` to regenerate `.astro/types.d.ts` for the new Content Layer API.

IMPORTANT: The content files in `src/content/projects/` stay exactly where they are. Only the config file moves. The glob loader's `base: './src/content/projects'` points to the existing content directory.

IMPORTANT: The `ProjectsSection.astro` component uses `getCollection('projects')` and accesses `project.data.language`, `project.data.isDraft`, etc. In Content Layer API, entries still have `.data` with the schema-validated fields. The component code does NOT need changes — it does not use `.slug`, `.render()`, or any removed APIs.
  </action>
  <verify>
1. Run `pnpm astro sync` — should complete without errors
2. Run `pnpm astro check` — should pass with 0 errors (warnings acceptable)
3. Run `pnpm build` — should build all 4 locales without errors
4. Verify `src/content.config.ts` exists and `src/content/config.ts` is deleted
5. Verify `.astro/types.d.ts` was regenerated
  </verify>
  <done>
Content Layer API active with glob loader for projects collection. Old config removed. TypeScript types regenerated. Build passes for all 4 locales. No content file changes needed — all 20 entries (5 projects x 4 locales) validate against existing schema.
  </done>
</task>

</tasks>

<verification>
1. `pnpm ls astro` shows version 5.x
2. `pnpm ls @astrojs/mdx` shows version 4.x
3. `pnpm ls @astrojs/react` shows version 4.x
4. `pnpm ls @astrojs/sitemap` shows version 3.7+
5. `src/content.config.ts` exists with `glob()` loader
6. `src/content/config.ts` does NOT exist (deleted)
7. `pnpm astro check` passes with 0 errors
8. `pnpm build` succeeds for all 4 locales
</verification>

<success_criteria>
- Astro 5 installed with Vite 6 build system (ASTRO-01)
- Content Layer API active with glob loader replacing legacy type-based config (ASTRO-02)
- All integrations at Astro 5-compatible versions (ASTRO-04)
- TypeScript configuration updated for Astro 5 type generation
- Build succeeds for all locale pages
</success_criteria>

<output>
After completion, create `.planning/phases/03-astro-5-upgrade/03-01-SUMMARY.md`
</output>
